---
title: "Exploring the CitiBike Data in New York"
output: html_notebook
---

```{r, include = F}
rm(list = ls())

library(tidyverse)
library(lubridate)
library(ggmap)
library(data.table)
library(viridis)
library(sf)
library(units)
library(ggthemes)
library(parallel)
library(leaflet)
library(rjson)
library(mapview)
library(magick)
library(rprojroot)
library(widgetframe)

knitr::opts_chunk$set(echo = T, warning = F, message = F)
```

```{r setup}
PROJECT_ROOT <- find_root('CitiBike.Rproj')
```

## Exploring the New York City CitiBike data

This project explores the CitiBike program data from New York City.

A few notes:

* The full project (Github repo) can be found [here](https://mrkaye97.github.io/CitiBike/).
* All R code is in `~/CitiBike/R`
* All python code is in `~/CitiBike/python`
* Some data used in certain files can be found in `~/CitiBike/data`, but much is pulled directly from online sources.

### Setup

The project requires no explicit setup. All data is either included in this repo or comes directly from the CitiBike website.

A handful of R and Python packages are needed to run the project. See the bottom of this README for a list.

### Data

The data comes from the [CitiBike program](https://www.citibikenyc.com/system-data) directly, and is publicly available for download.

Below is a glimpse at the structure of the data

```{r}
fread(paste(PROJECT_ROOT, '/data/citibike_dat_1.csv', sep = ""), verbose = F, showProgress = F) %>%
  mutate(starttime = starttime %>% as_datetime(),
         stoptime = stoptime %>% as_datetime(),
         bikeid = bikeid %>% as.factor()) %>%
  sample_n(size = 100) %>%
  glimpse()
```

## Plots

#### Visualizing Commute Patterns -- Heatmap of start and end stations by time of day
<img src="https://raw.githubusercontent.com/mrkaye97/CitiBike/master/viz/commutes.svg">


#### Coronavirus Impact on Ridership

<img src="https://raw.githubusercontent.com/mrkaye97/CitiBike/master/viz/coronavirus-and-day-dsn.svg">


#### Common Routes

```{r}
df <- read.csv('https://raw.githubusercontent.com/mrkaye97/CitiBike/master/data/for_common_routes_leaflet.csv')

grouped_coords <- function(coord, group, order) {
  data.frame(coord = coord, group = group) %>%
    group_by(group) %>%
    purrrlyr::by_slice(~c(.$coord, NA), .to = "output") %>%
    left_join(data.frame(group = group, order = order) %>% distinct(), by = 'group') %>%
    arrange(order) %>%
    .$output %>%
    unlist()
}

pal <- colorFactor(
  palette = "magma", domain = NULL)

# Map using Leaflet R
l <- leaflet(df) %>%
  addProviderTiles("CartoDB.Positron") %>% 
  addPolylines(
    lng = ~grouped_coords(lon, routeid, rownames(df)),
    lat = ~grouped_coords(lat, routeid, rownames(df)),
    color = ~pal(df$numroute)) 
```

<center>
```{r, fig.width = 9, echo = F}
suppressWarnings(l)
```
</center>

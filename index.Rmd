---
title: "Index"
author: "Matt Kaye"
date: "6/10/2020"
output: 
  html_notebook: 
    self_contained: yes
always_allow_html: no
---

```{r, include = F}
rm(list = ls())

library(tidyverse)
library(lubridate)
library(ggmap)
library(data.table)
library(viridis)
library(sf)
library(units)
library(ggthemes)
library(parallel)
library(leaflet)
library(rjson)
library(mapview)
library(magick)
library(rprojroot)
library(widgetframe)

knitr::opts_chunk$set(echo = F, warning = F, message = F)

PROJECT_ROOT <- find_root('CitiBike.Rproj')
```

## Plots

#### Visualizing Commute Patterns -- Heatmap of start and end stations by time of day
<img src="https://raw.githubusercontent.com/mrkaye97/CitiBike/master/viz/commutes.svg">


#### Coronavirus Impact on Ridership

<img src="https://raw.githubusercontent.com/mrkaye97/CitiBike/master/viz/coronavirus-and-day-dsn.svg">


#### Common Routes

<center>
```{r, align = 'c'}
df <- read.csv('https://raw.githubusercontent.com/mrkaye97/CitiBike/master/data/for_common_routes_leaflet.csv')

grouped_coords <- function(coord, group, order) {
  data.frame(coord = coord, group = group) %>%
    group_by(group) %>%
    purrrlyr::by_slice(~c(.$coord, NA), .to = "output") %>%
    left_join(data.frame(group = group, order = order) %>% distinct(), by = 'group') %>%
    arrange(order) %>%
    .$output %>%
    unlist()
}

pal <- colorFactor(
  palette = "magma", domain = NULL)

# Map using Leaflet R
l <- leaflet(df) %>%
  addProviderTiles("CartoDB.Positron") %>% 
  addPolylines(
    lng = ~grouped_coords(lon, routeid, rownames(df)),
    lat = ~grouped_coords(lat, routeid, rownames(df)),
    color = ~pal(df$numroute)) 

l %>%
  frameWidget()
```
</center>
